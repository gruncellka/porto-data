name: Porto Data Validation

on: [push, pull_request]

jobs:
    validate:
        runs-on: ubuntu-22.04
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: '3.11'
                  cache: 'pip'
            - name: Install dependencies
              run: make setup
            - name: Validate JSON files against schemas
              run: make validate-json
            - name: Lint JSON syntax
              run: make lint-json
            - name: Check JSON formatting
              run: make format-json-check
            - name: Check Python code formatting
              run: make format-code-check
            - name: Lint Python code
              run: make lint-code
            - name: Type check Python code
              run: make type-check
            - name: Verify metadata.json is up to date
              run: |
                . venv/bin/activate && python3 scripts/generate_metadata.py
                if [ -n "$(git diff metadata.json)" ]; then
                  echo "❌ metadata.json is out of date. The file must be regenerated and committed."
                  echo "Run 'make metadata' locally, then commit the updated metadata.json file."
                  git diff metadata.json
                  exit 1
                fi
                echo "✓ metadata.json is up to date"
            - name: Run pre-commit checks (verify all hooks pass)
              run: |
                . venv/bin/activate && pre-commit run --all-files
