name: validation

on: [push, pull_request]

env:
    PYTHON_VERSION: "3.11"

jobs:
    # ==========================================
    # JSON Validation (MUST RUN FIRST)
    # ==========================================
    # These can run in parallel - both just need valid JSON files
    validate-schemas:
        name: üìã Validate JSON Schemas
        runs-on: ubuntu-22.04
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: 'pip'
            - name: Install dependencies
              run: make setup
            - name: Validate JSON files against schemas
              run: |
                  . venv/bin/activate && porto validate --type schema

    lint-json:
        name: üîç Lint JSON Syntax
        runs-on: ubuntu-22.04
        # No dependency - just checks JSON syntax, doesn't need schemas
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: 'pip'
            - name: Install dependencies
              run: make setup
            - name: Lint JSON syntax
              run: make lint-json

    # ==========================================
    # Data Links Validation (needs valid schemas)
    # ==========================================
    validate-data-links:
        name: üîó Validate Data Links
        runs-on: ubuntu-22.04
        needs: [validate-schemas]
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: 'pip'
            - name: Install dependencies
              run: make setup
            - name: Validate data_links.json consistency
              run: |
                  . venv/bin/activate && porto validate --type links

    # ==========================================
    # Formatting Checks (needs valid data)
    # ==========================================
    format-json:
        name: ‚ú® Check JSON Formatting
        runs-on: ubuntu-22.04
        needs: [validate-schemas, validate-data-links]
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: 'pip'
            - name: Install dependencies
              run: make setup
            - name: Check JSON formatting
              run: make format-json-check

    verify-metadata:
        name: üìä Verify Metadata
        runs-on: ubuntu-22.04
        needs: [validate-schemas, validate-data-links]
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: 'pip'
            - name: Install dependencies
              run: make setup
            - name: Verify metadata.json is up to date
              run: |
                  . venv/bin/activate && porto metadata
                  if [ -n "$(git diff metadata.json)" ]; then
                    echo "‚ùå metadata.json is out of date. The file must be regenerated and committed."
                    echo "Run 'make metadata' locally, then commit the updated metadata.json file."
                    git diff metadata.json
                    exit 1
                  fi
                  echo "‚úì metadata.json is up to date"

    # ==========================================
    # Python Code Quality (independent of JSON)
    # ==========================================
    # These can run in parallel with JSON validation - completely independent
    format-code:
        name: üêç Check Python Formatting
        runs-on: ubuntu-22.04
        # No dependency - Python code is independent of JSON validation
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: 'pip'
            - name: Install dependencies
              run: make setup
            - name: Check Python code formatting
              run: make format-code-check

    lint-code:
        name: üîé Lint Python Code
        runs-on: ubuntu-22.04
        # No dependency - Python code is independent of JSON validation
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: 'pip'
            - name: Install dependencies
              run: make setup
            - name: Lint Python code
              run: make lint-code

    type-check:
        name: üìù Type Check Python
        runs-on: ubuntu-22.04
        # No dependency - Python code is independent of JSON validation
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: 'pip'
            - name: Install dependencies
              run: make setup
            - name: Type check Python code
              run: make type-check

    # ==========================================
    # Python Tests (CLI and scripts)
    # ==========================================
    test:
        name: üß™ Run Tests with Coverage
        runs-on: ubuntu-22.04
        # Tests can run in parallel with other checks
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: 'pip'
            - name: Install dependencies
              run: make setup
            - name: Run tests with coverage
              run: make test-cov
            - name: Upload coverage reports to Codecov
              uses: codecov/codecov-action@v5
              continue-on-error: true
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}

    # ==========================================
    # Final Summary (waits for all checks)
    # ==========================================
    validation:
        name: Porto Data Validation
        runs-on: ubuntu-22.04
        needs:
            - validate-schemas
            - lint-json
            - validate-data-links
            - format-json
            - verify-metadata
            - format-code
            - lint-code
            - type-check
            - test
        steps:
            - name: All validation checks passed
              run: echo "‚úÖ All validation checks passed successfully!"
