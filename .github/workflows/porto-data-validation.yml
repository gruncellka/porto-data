name: porto-data-validation

on: [push, pull_request]

jobs:
    # ==========================================
    # JSON Validation (MUST RUN FIRST)
    # ==========================================
    validate-schemas:
        name: üìã Validate JSON Schemas
        runs-on: ubuntu-22.04
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: '3.11'
                  cache: 'pip'
            - name: Install dependencies
              run: make setup
            - name: Validate JSON files against schemas
              run: |
                  . venv/bin/activate && python3 scripts/validate_schemas.py

    validate-data-links:
        name: üîó Validate Data Links
        runs-on: ubuntu-22.04
        needs: [validate-schemas]
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: '3.11'
                  cache: 'pip'
            - name: Install dependencies
              run: make setup
            - name: Validate data_links.json consistency
              run: |
                  . venv/bin/activate && python3 scripts/validate_data_links.py

    lint-json:
        name: üîç Lint JSON Syntax
        runs-on: ubuntu-22.04
        needs: [validate-schemas]
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: '3.11'
                  cache: 'pip'
            - name: Install dependencies
              run: make setup
            - name: Lint JSON syntax
              run: make lint-json

    # ==========================================
    # Formatting and Code Quality (runs after validation)
    # ==========================================
    format-json:
        name: ‚ú® Check JSON Formatting
        runs-on: ubuntu-22.04
        needs: [validate-schemas, validate-data-links]
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: '3.11'
                  cache: 'pip'
            - name: Install dependencies
              run: make setup
            - name: Check JSON formatting
              run: make format-json-check

    format-code:
        name: üêç Check Python Formatting
        runs-on: ubuntu-22.04
        needs: [validate-schemas]
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: '3.11'
                  cache: 'pip'
            - name: Install dependencies
              run: make setup
            - name: Check Python code formatting
              run: make format-code-check

    lint-code:
        name: üîé Lint Python Code
        runs-on: ubuntu-22.04
        needs: [validate-schemas]
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: '3.11'
                  cache: 'pip'
            - name: Install dependencies
              run: make setup
            - name: Lint Python code
              run: make lint-code

    type-check:
        name: üìù Type Check Python
        runs-on: ubuntu-22.04
        needs: [validate-schemas]
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: '3.11'
                  cache: 'pip'
            - name: Install dependencies
              run: make setup
            - name: Type check Python code
              run: make type-check

    verify-metadata:
        name: üìä Verify Metadata
        runs-on: ubuntu-22.04
        needs: [validate-schemas, validate-data-links]
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: '3.11'
                  cache: 'pip'
            - name: Install dependencies
              run: make setup
            - name: Verify metadata.json is up to date
              run: |
                  . venv/bin/activate && python3 scripts/generate_metadata.py
                  if [ -n "$(git diff metadata.json)" ]; then
                    echo "‚ùå metadata.json is out of date. The file must be regenerated and committed."
                    echo "Run 'make metadata' locally, then commit the updated metadata.json file."
                    git diff metadata.json
                    exit 1
                  fi
                  echo "‚úì metadata.json is up to date"

    porto-data-validation:
        name: Porto Data Validation
        runs-on: ubuntu-22.04
        needs:
            - validate-schemas
            - validate-data-links
            - lint-json
            - format-json
            - format-code
            - lint-code
            - type-check
            - verify-metadata
        steps:
            - name: All validation checks passed
              run: echo "‚úÖ All validation checks passed successfully!"
