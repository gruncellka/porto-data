# Pre-commit configuration for porto-data
#
# Benefits:
# - Automatic staging of modified files (fixes the uncommitted files bug!)
# - Only processes changed files (faster)
# - Better caching and parallel execution
# - Standard tool used industry-wide
#
# Run manually: pre-commit run --all-files
# Update hooks: pre-commit autoupdate

repos:
    # ==========================================
    # JSON Validation (MUST RUN FIRST)
    # ==========================================
    # Schema validation and metadata generation
    # Note: metadata.json is automatically staged if modified
    - repo: local
      hooks:
          - id: validate-schemas
            name: Validate schemas and generate metadata
            entry: bash -c 'if [ -f venv/bin/activate ]; then . venv/bin/activate; fi && python3 scripts/validate_schemas.py'
            language: system
            files: ^(data|schemas)/.*\.json$
            pass_filenames: false
            always_run: false

          - id: validate-data-links
            name: Validate data_links.json consistency
            entry: bash -c 'if [ -f venv/bin/activate ]; then . venv/bin/activate; fi && python3 scripts/validate_data_links.py'
            language: system
            files: ^data/data_links\.json$|^data/(products|zones|weight_tiers|services|prices)\.json$
            pass_filenames: false
            always_run: false

    # JSON syntax validation
    - repo: local
      hooks:
          - id: lint-json
            name: Validate JSON syntax
            entry: bash -c 'for file in data/*.json schemas/*.json; do [ -f "$file" ] && python3 -m json.tool "$file" > /dev/null || exit 1; done'
            language: system
            types: [json]
            files: ^(data|schemas)/.*\.json$
            pass_filenames: false
            always_run: false

    # ==========================================
    # Standard Pre-commit Hooks
    # ==========================================
    - repo: https://github.com/pre-commit/pre-commit-hooks
      rev: v4.5.0
      hooks:
          - id: trailing-whitespace
          - id: end-of-file-fixer
          - id: check-yaml
          - id: check-json
          - id: check-added-large-files
            args: ['--maxkb=300']
          - id: check-merge-conflict
          - id: check-case-conflict
          - id: no-commit-to-branch
            args: ['--branch', 'main']
          - id: detect-private-key

    # ==========================================
    # JSON Formatting (runs after validation)
    # ==========================================
    # JSON formatting (uses json.tool like Makefile)
    - repo: local
      hooks:
          - id: format-json
            name: Format JSON files
            entry: bash -c 'for file in data/*.json schemas/*.json; do [ -f "$file" ] && python3 -m json.tool "$file" "$file.tmp" && mv "$file.tmp" "$file" || true; done'
            language: system
            types: [json]
            files: ^(data|schemas)/.*\.json$
            pass_filenames: false
            always_run: false

    # ==========================================
    # Python Code Quality (porto-data only)
    # ==========================================

    # Ruff formatter (matches pyproject.toml: line-length=100)
    - repo: https://github.com/astral-sh/ruff-pre-commit
      rev: v0.1.15
      hooks:
          - id: ruff-format
            args: ['--line-length=100']
            files: ^scripts/.*\.py$

          # Ruff linter with auto-fix
          - id: ruff
            args: ['--fix', '--exit-non-zero-on-fix']
            files: ^scripts/.*\.py$

    # MyPy type checking
    - repo: https://github.com/pre-commit/mirrors-mypy
      rev: v1.8.0
      hooks:
          - id: mypy
            additional_dependencies: [types-jsonschema, types-toml]
            args: ['--config-file=pyproject.toml']
            files: ^scripts/.*\.py$
