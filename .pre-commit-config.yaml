# Pre-commit configuration for porto-data
#
# Workflow when data/schema files change:
# 1. pre-commit validates and regenerates metadata.json
# 2. If metadata changed, commit FAILS (by design)
# 3. User reviews changes: git diff metadata.json
# 4. User stages and re-commits: git add metadata.json && git commit
#
# Run manually: pre-commit run --all-files
# Update hooks: pre-commit autoupdate

# Stop on first failure (cleaner error messages)
fail_fast: true

repos:
    # ==========================================
    # JSON Validation (MUST RUN FIRST)
    # ==========================================
    - repo: local
      hooks:
          - id: validate-schemas
            name: Validate JSON schemas
            entry: bash -c 'if [ -f venv/bin/activate ]; then . venv/bin/activate; fi && porto validate --type schema'
            language: system
            files: ^(data|schemas)/.*\.json$
            pass_filenames: false
            always_run: false

          - id: validate-data-links
            name: Validate data_links.json consistency
            entry: bash -c 'if [ -f venv/bin/activate ]; then . venv/bin/activate; fi && porto validate --type links'
            language: system
            files: ^data/data_links\.json$|^data/(products|zones|weight_tiers|services|prices)\.json$
            pass_filenames: false
            always_run: false

          - id: generate-metadata
            name: Generate metadata.json
            entry: bash -c 'if [ -f venv/bin/activate ]; then . venv/bin/activate; fi && porto metadata'
            language: system
            files: ^(data|schemas)/.*\.json$
            pass_filenames: false
            always_run: false

    # JSON syntax validation
    - repo: local
      hooks:
          - id: lint-json
            name: Validate JSON syntax
            entry: bash -c 'for file in data/*.json schemas/*.json; do [ -f "$file" ] && python3 -m json.tool "$file" > /dev/null || exit 1; done'
            language: system
            types: [json]
            files: ^(data|schemas)/.*\.json$
            pass_filenames: false
            always_run: false

    # ==========================================
    # Standard Pre-commit Hooks
    # ==========================================
    - repo: https://github.com/pre-commit/pre-commit-hooks
      rev: v4.5.0
      hooks:
          - id: trailing-whitespace
          - id: end-of-file-fixer
          - id: check-yaml
          - id: check-json
          - id: check-added-large-files
            args: ['--maxkb=300']
          - id: check-merge-conflict
          - id: check-case-conflict
          - id: no-commit-to-branch
            args: ['--branch', 'main']
          - id: detect-private-key

    # ==========================================
    # JSON Formatting (runs after validation)
    # ==========================================
    # JSON formatting (uses json.tool like Makefile)
    - repo: local
      hooks:
          - id: format-json
            name: Format JSON files
            entry: bash -c 'for file in data/*.json schemas/*.json; do [ -f "$file" ] && python3 -m json.tool "$file" "$file.tmp" && mv "$file.tmp" "$file" || true; done'
            language: system
            types: [json]
            files: ^(data|schemas)/.*\.json$
            pass_filenames: false
            always_run: false

    # ==========================================
    # Python Code Quality (porto-data only)
    # ==========================================

    # Ruff formatter (matches pyproject.toml: line-length=100)
    - repo: https://github.com/astral-sh/ruff-pre-commit
      rev: v0.1.15
      hooks:
          - id: ruff-format
            args: ['--line-length=100']
            files: ^(scripts|cli)/.*\.py$

          # Ruff linter with auto-fix
          - id: ruff
            args: ['--fix', '--exit-non-zero-on-fix']
            files: ^(scripts|cli)/.*\.py$

    # MyPy type checking
    - repo: local
      hooks:
          - id: mypy
            name: Type check Python code
            entry: bash -c 'if [ -f venv/bin/activate ]; then . venv/bin/activate; fi && PYTHONPATH=. mypy --config-file=pyproject.toml scripts/ cli/'
            language: system
            files: ^(scripts|cli)/.*\.py$
            pass_filenames: false
            always_run: false
